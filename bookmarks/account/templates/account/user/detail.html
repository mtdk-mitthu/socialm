{% extends "base.html" %}
{% load thumbnail %}

{% block title %}{{ user.get_full_name }}{% endblock %}

{% block content %}
  <h1>{{ user.get_full_name }}</h1>
  
  <div class="profile-info">
    {# Display Profile Photo #}
    {% if user.profile.photo %}
        {% thumbnail user.profile.photo 180x180 crop="100%" as im %}
        <img src="{{ im.url }}" class="user-detail">
    {% else %}
        {# Fallback if no photo #}
        <img src="#" class="user-detail" alt="No Photo">
    {% endif %}
  </div>

  {% with total_followers=user.followers.count %}
    <span class="count">
      <span class="total">{{ total_followers }}</span>
      follower{{ total_followers|pluralize }}
    </span>
    
    {# Follow/Unfollow Button #}
    <a href="#" data-id="{{ user.id }}" 
       data-action="{% if request.user in user.followers.all %}unfollow{% else %}follow{% endif %}"
       class="follow button">
      {% if request.user not in user.followers.all %}
        Follow
      {% else %}
        Unfollow
      {% endif %}
    </a>

    {# List of images created by this user #}
    <div id="image-list" class="image-container">
      {% include "images/image/list_images.html" with images=user.images_created.all %}
    </div>
  {% endwith %}


<div class="stats-container">
    <a href="#" class="stat-pill likes" data-id="{{ image.id }}" data-action="{% if request.user in image.users_like.all %}un{% endif %}like">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        <span class="count">{{ total_likes }}</span> likes
    </a>

    <div class="stat-pill views">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <span>{{ total_views }}</span> views
    </div>
</div>

<div class="stats-container">
    <a href="#" data-id="{{ user.id }}" data-action="{% if request.user in user.followers.all %}un{% endif %}follow" class="btn-follow {% if request.user in user.followers.all %}unfollow{% endif %}">
        
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6m3-3h-6M6 14a6 6 0 0112 0M12 10a4 4 0 110-8 4 4 0 010 8z"></path>
        </svg>
        
        {% if request.user not in user.followers.all %}
            Follow
        {% else %}
            Unfollow
        {% endif %}
    </a>
</div>


{% endblock %}

{% block domready %}
  const url = '{% url "user_follow" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }

  document.querySelector('a.follow')
    .addEventListener('click', function(e){
      e.preventDefault();
      var followButton = this;

      // add request body
      var formData = new FormData();
      formData.append('id', followButton.dataset.id);
      formData.append('action', followButton.dataset.action);
      options['body'] = formData;

      // send HTTP request
      fetch(url, options)
        .then(response => response.json())
        .then(data => {
          if (data['status'] === 'ok') {
            var previousAction = followButton.dataset.action;

            // toggle button text and data-action
            var action = previousAction === 'follow' ? 'unfollow' : 'follow';
            followButton.dataset.action = action;
            followButton.innerHTML = action;

            // update follower count
            var followerCount = document.querySelector('span.count .total');
            var totalFollowers = parseInt(followerCount.innerHTML);
            
            // LOGIC: If we just followed, +1. If we unfollowed, -1.
            followerCount.innerHTML = previousAction === 'follow' ? totalFollowers + 1 : totalFollowers - 1;
          }
        })
    });
    
{% endblock %}